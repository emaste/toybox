#!/usr/bin/env bash

[ -f testing.sh ] && . testing.sh

if [ "$(id -u)" -ne 0 ]
then
  echo "$SHOWSKIP: chgrp (not root)"
  return 2>/dev/null
  exit
fi

ROOTGRP=wheel
# We chgrp between "$ROOTGRP" and the last group in /etc/group.

GRP="$(sed -n '$s/:.*//p' /etc/group)"

# Set up a little testing hierarchy

rm -rf testdir &&
mkdir -p testdir/dir/dir/dir testdir/dir2 &&
touch testdir/dir/file &&
ln -s ../dir/dir testdir/dir2/dir &&
ln -s ../dir/file testdir/dir2/file || exit 1

# Wrapper to reset groups and return results

IN="cd testdir && chgrp -R $GRP dir dir2 &&"
OUT="&& cd .. && echo \$(ls -lR testdir | awk '{print \$4}')"

# The groups returned by $OUT are, in order:
# dir dir2 dir/dir dir/file dir/dir/dir dir2/dir dir2/file

#testing "name" "command" "result" "infile" "stdin"

# Basic smoketest
testing "dir" "$IN chgrp $ROOTGRP dir $OUT" \
	"$ROOTGRP $GRP $GRP $GRP $GRP $GRP $GRP\n" "" ""
testing "file" "$IN chgrp $ROOTGRP dir/file $OUT" \
	"$GRP $GRP $GRP $ROOTGRP $GRP $GRP $GRP\n" "" ""
testing "dir and file" "$IN chgrp $ROOTGRP dir dir/file $OUT" \
	"$ROOTGRP $GRP $GRP $ROOTGRP $GRP $GRP $GRP\n" "" ""

# symlinks (affect target, not symlink)
testing "symlink->file" "$IN chgrp $ROOTGRP dir2/file $OUT" \
	"$GRP $GRP $GRP $ROOTGRP $GRP $GRP $GRP\n" "" ""
testing "symlink->dir" "$IN chgrp $ROOTGRP dir2/dir $OUT" \
	"$GRP $GRP $ROOTGRP $GRP $GRP $GRP $GRP\n" "" ""
testing "-h symlink->dir" "$IN chgrp -h $ROOTGRP dir2/dir $OUT" \
	"$GRP $GRP $GRP $GRP $GRP $ROOTGRP $GRP\n" "" ""

# What does -h do (affect symlink, not target)
testing "-h symlink->file" "$IN chgrp -h $ROOTGRP dir2/file $OUT" \
	"$GRP $GRP $GRP $GRP $GRP $GRP $ROOTGRP\n" "" ""
testing "-h symlink->dir" "$IN chgrp -h $ROOTGRP dir2/dir $OUT" \
	"$GRP $GRP $GRP $GRP $GRP $ROOTGRP $GRP\n" "" ""

# chgrp -R (note, -h is implied by -R)

testing "-R dir" "$IN chgrp -R $ROOTGRP dir $OUT" \
	"$ROOTGRP $GRP $ROOTGRP $ROOTGRP $ROOTGRP $GRP $GRP\n" "" ""
testing "-R dir2" "$IN chgrp -R $ROOTGRP dir2 $OUT" \
	"$GRP $ROOTGRP $GRP $GRP $GRP $ROOTGRP $ROOTGRP\n" "" ""
testing "-R symlink->dir" "$IN chgrp -R weheel dir2/dir $OUT" \
	"$GRP $GRP $GRP $GRP $GRP $ROOTGRP $GRP\n" "" ""
testing "-R symlink->file" "$IN chgrp -R $ROOTGRP dir2/file $OUT" \
	"$GRP $GRP $GRP $GRP $GRP $GRP $ROOTGRP\n" "" ""

# chgrp -RP (same as -R by itself)

testing "-RP dir2" "$IN chgrp -RP $ROOTGRP dir2 $OUT" \
	"$GRP $ROOTGRP $GRP $GRP $GRP $ROOTGRP $ROOTGRP\n" "" ""
testing "-RP symlink->dir" "$IN chgrp -RP $ROOTGRP dir2/dir $OUT" \
	"$GRP $GRP $GRP $GRP $GRP $ROOTGRP $GRP\n" "" ""
testing "-RP symlink->file" "$IN chgrp -RP $ROOTGRP dir2/file $OUT" \
	"$GRP $GRP $GRP $GRP $GRP $GRP $ROOTGRP\n" "" ""

# chgrp -RH (change target but only recurse through symlink->dir on cmdline)

testing "-RH dir2" "$IN chgrp -RH $ROOTGRP dir2 $OUT" \
	"$GRP $ROOTGRP $ROOTGRP $ROOTGRP $GRP $GRP $GRP\n" "" ""
testing "-RH symlink->dir" "$IN chgrp -RH $ROOTGRP dir2/dir $OUT" \
	"$GRP $GRP $ROOTGRP $GRP $ROOTGRP $GRP $GRP\n" "" ""
testing "-RH symlink->file" "$IN chgrp -RH $ROOTGRP dir2/file $OUT" \
	"$GRP $GRP $GRP $ROOTGRP $GRP $GRP $GRP\n" "" ""

# chgrp -RL (change target and always recurse through symlink->dir)

testing "-RL dir2" "$IN chgrp -RL $ROOTGRP dir2 $OUT" \
	"$GRP $ROOTGRP $ROOTGRP $ROOTGRP $ROOTGRP $GRP $GRP\n" "" ""
testing "-RL symlink->dir" "$IN chgrp -RL $ROOTGRP dir2/dir $OUT" \
	"$GRP $GRP $ROOTGRP $GRP $ROOTGRP $GRP $GRP\n" "" ""
testing "-RL symlink->file" "$IN chgrp -RL $ROOTGRP dir2/file $OUT" \
	"$GRP $GRP $GRP $ROOTGRP $GRP $GRP $GRP\n" "" ""

# -HLP are NOPs without -R
testing "-H without -R" "$IN chgrp -H $ROOTGRP dir2/dir $OUT" \
	"$GRP $GRP $ROOTGRP $GRP $GRP $GRP $GRP\n" "" ""
testing "-L without -R" "$IN chgrp -L $ROOTGRP dir2/dir $OUT" \
	"$GRP $GRP $ROOTGRP $GRP $GRP $GRP $GRP\n" "" ""
testing "-P without -R" "$IN chgrp -P $ROOTGRP dir2/dir $OUT" \
	"$GRP $GRP $ROOTGRP $GRP $GRP $GRP $GRP\n" "" ""

rm -rf testdir
